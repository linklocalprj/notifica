<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cleanup Media</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }
    button { padding: 4px 8px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>Post inviati – pulizia media</h1>
  <p class="muted">Qui vedi i post con <code>stato_invio = sent</code>. Clicca “Elimina media” per sostituire <code>immagine_url</code> con il placeholder.</p>

  <table id="posts-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Piattaforma</th>
        <th>Cliente</th>
        <th>Data Pubblicazione</th>
        <th>Media (preview)</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
  const tableLabels = {
    pubblicazioni_facebook:  'Facebook',
    pubblicazioni_instagram: 'Instagram',
    pubblicazioni_linkedin:  'LinkedIn',
    pubblicazioni_google:    'Google'
  };

  const PLACEHOLDER = 'https://via.placeholder.com/1200x1200?text=MEDIA';

  async function loadAllForCleanup() {
    try {
      const res = await fetch('/api/loadAllForCleanup');
      if (!res.ok) throw new Error(await res.text());
      const raw = await res.json();
      if (!Array.isArray(raw)) throw new Error('Formato dati non valido');

      const rows = raw.map(r => ({
        ...r,
        piattaforma: tableLabels[r.table] ?? r.table
      }));
      renderTable(rows);
    } catch (e) {
      alert('Errore caricamento: ' + e.message);
    }
  }

  function renderTable(rows) {
    const tbody = document.querySelector('#posts-table tbody');
    tbody.innerHTML = '';

    rows.forEach(r => {
      const cliente   = r.nome_azienda ?? r.azienda ?? '-';
      const dataPub   = r.data_pubblicazione || '-';
      const mediaUrl  = r.immagine_url || r.video_url || r.media || '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.piattaforma}</td>
        <td>${cliente}</td>
        <td>${dataPub}</td>
        <td>${typeof mediaUrl === 'string' && mediaUrl !== '-' ? `<a href="${mediaUrl}" target="_blank">apri</a>` : '-'}</td>
        <td><button id="btn-del-${r.table}-${r.id}">Elimina media</button></td>
      `;
      tbody.appendChild(tr);

      document.getElementById(`btn-del-${r.table}-${r.id}`)
        .addEventListener('click', () => eliminaMedia(r));
    });
  }

  async function eliminaMedia(row) {
    const btnId = `btn-del-${row.table}-${row.id}`;
    const btn = document.getElementById(btnId);
    btn.disabled = true;
    const prevTxt = btn.textContent;
    btn.textContent = '…';

    try {
      const resp = await fetch('/api/resetImage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          table: row.table,
          id: row.id,
          placeholder: PLACEHOLDER
        })
      });
      if (!resp.ok) throw new Error(await resp.text());

      // Aggiorna la UI locale
      row.immagine_url = PLACEHOLDER;
      btn.textContent = '✅';
    } catch (err) {
      alert('Errore: ' + err.message);
      btn.disabled = false;
      btn.textContent = prevTxt;
    }
  }

  document.addEventListener('DOMContentLoaded', loadAllForCleanup);
</script>
</body>
</html>
