<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cleanup Media</title>
  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }
    button { padding: 4px 8px; margin: 0 2px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>Post inviati â€“ pulizia media</h1>
  <p class="muted">
    Qui vedi i post con <code>stato_invio = sent</code>.  
    - <b>Elimina media</b>: rimuove il file dal bucket.  
    - <b>Elimina riga</b>: sostituisce con placeholder e marca come completato.
  </p>

  <table id="posts-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Piattaforma</th>
        <th>Cliente</th>
        <th>Data Pubblicazione</th>
        <th>Media (preview)</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>ðŸ“‚ Tutti i file nel bucket</h2>
  <p class="muted">Elenco di tutti i file presenti nel bucket <code>post-images</code> con data di caricamento. Puoi eliminarli anche se non sono associati a un post.</p>
  <table id="bucket-table">
    <thead>
      <tr>
        <th>Nome file</th>
        <th>Data upload</th>
        <th>Preview</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
  const tableLabels = {
    pubblicazioni_facebook:  'Facebook',
    pubblicazioni_instagram: 'Instagram',
    pubblicazioni_linkedin:  'LinkedIn',
    pubblicazioni_google:    'Google'
  };

  const PLACEHOLDER = 'https://jljljrkubullcrspicvj.supabase.co/storage/v1/object/public/post-images/placeholders/placeholder.jpg';

  // ====================
  // SEZIONE 1: POST
  // ====================
  async function loadAllForCleanup() {
    try {
      const res = await fetch('/api/loadCleanImage?action=load');
      if (!res.ok) throw new Error(await res.text());
      const raw = await res.json();
      if (!Array.isArray(raw)) throw new Error('Formato dati non valido');

      const rows = raw.map(r => ({
        ...r,
        piattaforma: tableLabels[r.table] ?? r.table
      }));
      renderPostsTable(rows);
    } catch (e) {
      alert('Errore caricamento: ' + e.message);
    }
  }

  function renderPostsTable(rows) {
    const tbody = document.querySelector('#posts-table tbody');
    tbody.innerHTML = '';

    rows.forEach(r => {
      const cliente   = r.nome_azienda ?? r.azienda ?? '-';
      const dataPub   = r.data_pubblicazione || '-';
      const mediaUrl  = r.immagine_url || r.video_url || r.media || '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.piattaforma}</td>
        <td>${cliente}</td>
        <td>${dataPub}</td>
        <td>${typeof mediaUrl === 'string' && mediaUrl !== '-' ? `<a href="${mediaUrl}" target="_blank">apri</a>` : '-'}</td>
        <td>
          <button id="btn-del-media-${r.table}-${r.id}">ðŸ—‘ Elimina media</button>
          <button id="btn-del-riga-${r.table}-${r.id}">ðŸš« Elimina riga</button>
        </td>
      `;
      tbody.appendChild(tr);

      document
        .getElementById(`btn-del-media-${r.table}-${r.id}`)
        .addEventListener('click', () => eliminaSoloMedia(r));

      document
        .getElementById(`btn-del-riga-${r.table}-${r.id}`)
        .addEventListener('click', () => eliminaRiga(r));
    });
  }

  async function eliminaSoloMedia(row) {
    if (!row.immagine_url) {
      alert('Nessun media da eliminare');
      return;
    }
    const btn = document.getElementById(`btn-del-media-${row.table}-${row.id}`);
    btn.disabled = true;
    const prevTxt = btn.textContent;
    btn.textContent = 'â€¦';
    try {
      const resp = await fetch('/api/loadCleanImage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'deleteFile',
          oldUrl: row.immagine_url
        })
      });
      if (!resp.ok) throw new Error(await resp.text());
      alert('âœ… Media eliminato dal bucket');
    } catch (err) {
      alert('Errore eliminazione media: ' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = prevTxt;
    }
  }

  async function eliminaRiga(row) {
    const btn = document.getElementById(`btn-del-riga-${row.table}-${row.id}`);
    btn.disabled = true;
    const prevTxt = btn.textContent;
    btn.textContent = 'â€¦';
    try {
      const resp = await fetch('/api/loadCleanImage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'reset',
          table: row.table,
          id: row.id,
          placeholder: PLACEHOLDER
        })
      });
      if (!resp.ok) throw new Error(await resp.text());
      await loadAllForCleanup();
    } catch (err) {
      alert('Errore eliminazione riga: ' + err.message);
      btn.disabled = false;
      btn.textContent = prevTxt;
    }
  }

  // ====================
  // SEZIONE 2: BUCKET
  // ====================
  async function loadAllBucketFiles() {
    try {
      const res = await fetch('/api/loadCleanImage?action=listBucket');
      if (!res.ok) throw new Error(await res.text());
      const files = await res.json();
      renderBucketTable(files);
    } catch (e) {
      alert('Errore caricamento bucket: ' + e.message);
    }
  }

  function renderBucketTable(files) {
    const tbody = document.querySelector('#bucket-table tbody');
    tbody.innerHTML = '';

    files.forEach(f => {
      const tr = document.createElement('tr');
      const dateStr = f.created_at ? new Date(f.created_at).toLocaleString() : '-';
      tr.innerHTML = `
        <td>${f.name}</td>
        <td>${dateStr}</td>
        <td><a href="${f.url}" target="_blank">apri</a></td>
        <td><button id="btn-bucket-del-${encodeURIComponent(f.name)}">Elimina</button></td>
      `;
      tbody.appendChild(tr);

      document
        .getElementById(`btn-bucket-del-${encodeURIComponent(f.name)}`)
        .addEventListener('click', () => eliminaFileBucket(f.url));
    });
  }

  async function eliminaFileBucket(fileUrl) {
    if (!confirm('Eliminare definitivamente questo file?')) return;
    try {
      const resp = await fetch('/api/loadCleanImage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'deleteFile',
          oldUrl: fileUrl
        })
      });
      if (!resp.ok) throw new Error(await resp.text());
      await loadAllBucketFiles();
    } catch (err) {
      alert('Errore eliminazione file: ' + err.message);
    }
  }

  // ====================
  // INIT
  // ====================
  document.addEventListener('DOMContentLoaded', () => {
    loadAllForCleanup();
    loadAllBucketFiles();
  });
</script>

</body>
</html>
